<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <!-- 页面描述 -->
  <meta name="description" content=""/>
  <!-- 页面关键词 -->
  <meta name="keywords" content="" />
  <!-- 搜索引擎抓取 -->
  <meta name="robots" content="index,follow"/>
  <!-- 启用360浏览器的极速模式(webkit) -->
  <meta name="renderer" content="webkit">
  <!-- 避免IE使用兼容模式 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- 不让百度转码 -->
  <meta http-equiv="Cache-Control" content="no-siteapp"/>
  <!-- 针对手持设备优化，主要是针对一些老的不识别viewport的浏览器，比如黑莓 -->
  <meta name="HandheldFriendly" content="true">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
  <!-- 优先使用 IE 最新版本和 Chrome -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" type="image/x-icon" href="../static/favicon.ico">
  <title>微信</title>
  <style>
    /* * {
      padding: 0;
      margin: 0;
    } */
    html, body {
      background-color: skyblue;
      font-size: 16px;
      height: 50%;
      width: 100%;
      /* overflow: hidden; */
    }
    #index {
      padding: 10px;
    }
    #index .box > div {
      cursor: pointer;
      background-color: #fff;
      display: inline-block;
      padding: 5px;
      margin: 10px;
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
  <script src="https://cdn.bootcss.com/vConsole/3.1.0/vconsole.min.js"></script>
  <script src="http://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script>
</head>
<body>
  <div id="index">
    <div class="box">
      <div class="init">初始化微信</div>
      <div class="share">隐藏分享</div>
      <div class="wxSweep">扫一扫</div>
    </div>
    <!-- <div class="input-box">
      <input type="text" placeholder="请输入标题" class="title">
      <input type="text" placeholder="请输入描述" class="dec">
    </div>
    <span>书写完后，请点击右上角按钮，进行分享</span> -->
  </div>
</body>
<script>
  console.log('进入首页')
  new VConsole();
  let BASE_URL = 'http://wxtestapi.junlli.com'
  let init = false // 微信是否初始化

  // 拼装分享信息
  let shareData = {
    title: '咱的标题', // 分享标题
    desc: '咱的描述', // 分享描述
    link: window.location.href, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
    imgUrl: window.location.protocol + '//' + window.location.hostname + '/img.jpg', // 分享图标
    type: "link", // 分享类型,music、video或link，不填默认为link
    dataUrl: "", // 如果type是music或video，则要提供数据链接，默认为空
    success: function () {
      // 用户确认分享后执行的回调函数
      console.log("分享成功");
    },
    cancel: function () {
      // 用户取消分享后执行的回调函数
      console.log('分享取消')
    }
  }

  // 分享
  $('.share').on('click', function() {
    if (!init) return alert('请先初始化微信功能')
    wx.hideMenuItems({
      menuList: [
        'menuItem:share:appMessage', // 发送给朋友
        'menuItem:share:timeline' // 分享到朋友圈
      ] // 要显示的菜单项，所有menu项见附录3
    });
  })
  
  // 扫一扫
  $('.wxSweep').on('click', function() {
    if (!init) return alert('请先初始化微信功能')
    wx.scanQRCode({
      needResult: 0, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
      scanType: ["qrCode", "barCode"], // 可以指定扫二维码还是一维码，默认二者都有
      success: function (res) {
        var result = res.resultStr; // 当needResult 为 1 时，扫码返回的结果
        console.log('扫码成功')
      }
    })
  })

  // 初始化微信
  $('.box .init').on('click', function() {
    wxInit()
  })
  // 微信初始化
  let wxInit = function() {
    let myUrl = window.location.href.split('#')[0]
    console.log('我的url: ', myUrl)
    $.ajax({
      url: BASE_URL + '/getsign',
      type: 'post',
      data: {
        url: myUrl,
      },
      success: function(data) {
        console.log(data)
        wx.config({
          debug: false, // 开启调试模式,开发时可以开启
          appId: data.appId, // 必填，公众号的唯一标识   由接口返回
          timestamp: data.timestamp, // 必填，生成签名的时间戳 由接口返回
          nonceStr: data.noncestr, // 必填，生成签名的随机串 由接口返回
          url: data.url, // 必填，生成签名的随机串 由接口返回
          signature: data.signature, // 必填，签名 由接口返回
          jsApiList: [
            'updateAppMessageShareData',       // 分享到QQ 
            'scanQRCode', // 扫一扫
            'onMenuShareTimeline',
            'onMenuShareAppMessage',
            'onMenuShareQQ',
            'onMenuShareQZone ',
            'hideMenuItems',
            // 'onMenuShareQQ',         // 分享到QQ接口  
            // 'onMenuShareWeibo'      // 分享到微博接口 
          ] // 此处填你所用到的方法
        });
        // 方法监听
        wx.ready(function () {
          init = true
          console.log('初始化成功')
          wx.updateAppMessageShareData(shareData);
          wx.onMenuShareTimeline(shareData);
          wx.onMenuShareAppMessage(shareData);
          wx.onMenuShareQQ(shareData);
          wx.onMenuShareQZone(shareData);
          alert('初始化完成')
        })
        wx.error(function (res) {
          console.log('初始化失败')
          console.log(res)
        })
      },
      error: function(error) {
        console.log('错误')
      }
    })
  }
</script>
</html>
